{{- if or (eq .Values.global.secretStore.backend "vault") (not (hasKey .Values.global.secretStore "backend")) }}
{{- $hashicorp_vault_found := false }}
{{- range .Values.clusterGroup.applications }}
  {{- if . }} {{- /* Skip null applications */}}
    {{- if eq .chart "hashicorp-vault" }}
      {{- $hashicorp_vault_found = true }}
    {{- end }}
  {{- end }}
{{- end }}
---
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: vault-backend
  namespace: {{ .Values.ocpExternalSecrets.rbac.serviceAccount.namespace }}
spec:
  provider:
    vault:
      server: https://vault-vault.{{ .Values.global.hubClusterDomain }}
      path: secret
      # Version of KV backend
      version: v2
{{- if .Values.ocpExternalSecrets.caProvider.enabled }}
{{ if or .Values.clusterGroup.isHubCluster $hashicorp_vault_found }}
      caProvider:
        type: {{ .Values.ocpExternalSecrets.caProvider.hostCluster.type }}
        name: {{ .Values.ocpExternalSecrets.caProvider.hostCluster.name }}
        key: {{ .Values.ocpExternalSecrets.caProvider.hostCluster.key }}
        namespace: {{ .Values.ocpExternalSecrets.caProvider.hostCluster.namespace }}
{{ else }}
      caProvider:
        type: {{ .Values.ocpExternalSecrets.caProvider.clientCluster.type }}
        name: {{ .Values.ocpExternalSecrets.caProvider.clientCluster.name }}
        key: {{ .Values.ocpExternalSecrets.caProvider.clientCluster.key }}
        namespace: {{ .Values.ocpExternalSecrets.caProvider.clientCluster.namespace }}
{{ end }}
{{- end }}
      auth:
        kubernetes:
{{ if or .Values.clusterGroup.isHubCluster $hashicorp_vault_found }}
          mountPath: {{ .Values.ocpExternalSecrets.vault.mountPath }}
          role: {{ .Values.ocpExternalSecrets.rbac.rolename }}
{{ else }}
          mountPath: {{ $.Values.global.clusterDomain }}
          role: {{ $.Values.global.clusterDomain }}-role
{{ end }}
          secretRef:
            name: {{ .Values.ocpExternalSecrets.rbac.serviceAccount.name }}
            namespace: {{ .Values.ocpExternalSecrets.rbac.serviceAccount.namespace }}
            key: "token"
{{- end }}
